<!DOCTYPE html>
<html><head>
<title>SmartHousePC Devices View Page</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="HTML KickStart is a ultraâ€“lean set of HTML5, CSS, and jQuery (javascript) files, layouts, and elements designed to give you a headstart and save you a lot of hours on your next web project." />
<meta name="copyright" content="Joshua Gatcke 99lime.com All Rights Reserved" />
<script src="js/sorttable.js"></script>
<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script src="js/smarthouse.js"></script>
<link rel="stylesheet" type="text/css" href="css/style.css" media="all" /> 
<link rel="stylesheet" type="text/css" href="css/w3c.css" media="all" /> 
<link rel="stylesheet" type="text/css" href="css/kickstart.css" media="all" />               <!--  KICKSTART -->
<link rel="stylesheet" type="text/css" href="header.css" media="all" />        <!--   CUSTOM STYLES
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="js/kickstart.js"></script>                                  <!-- KICKSTART -->
</head><body>
<!-- ===================================== END HEADER ===================================== -->
<!-- ===================================== NAVIGATION BAR ===================================== -->
	<nav class="navbar">
			<a class="hide-phone" id="logo" href="http://duinocloud.org" title="Go to duinocloud eshop"><i class="fa fa-angle-right" style="float:right"> duino<span>Cloud.org</span></a></i>

			<ul  style="overflow:hidden" >
			<li class="hide-phone" ><a href="index.html" style="float:left" title="Go back to SmartHouse App Landing Page"><span>HTML</span>SmartHouse</a></li>

			
			<li class="show-phone" ><a href="index.html" style="float:right" title="Go back to SmartHouse App Landing Page"><i class="fa fa-home "></i></a></li>

			<li><a href="device_add.html" style="float:right" title="Add devices to be monitored or controlled"><i class="fa fa-plus "></i></a></li>
			

			<li><a href="device_config.html" style="float:right" title="Setup and configure"><i class="fa fa-gear "></i></a></li>
			<li><a href="help.html" style="float:right" title="Get Help"><i class="fa fa-info "></i></a></li>	
			<li><a href="cloud_connect.html" style="float:right" title="Connect to your Monitoring Cloud"><i class="fa fa-cloud "></i></a></li>

			</ul>
	</nav> 
<!-- ===================================== END NAVIGATION BAR ===================================== -->

	<div class="callout callout-top table-main" style="overflow:hidden">
	  
	<div class="w3-table-container">
	  <h4>Active Devices</h4>

		<div class="clear"></div><br/>
		<div id="status-handle">
			<!-- <p id="status-msg"> ... </p> -->
		</div>
		<div class="clear"></div><br/>	 

	  <table id="devices" class="sortable w3-table-all w3-large">
	    <thead>
	      <tr class="w3-light-grey w3-hover-grey">
	        <th>Description</th>
	        <th>Type</th>
	        <th>Status</th>
			<th>Actions</th>
	      </tr>
	    </thead>

	  </table>
	  </div>
	

		<div class="clear"></div><br/>
		<div class="clear"></div><br/>
		<div class="clear"></div><br/>

    <div>

		<div class="clear"></div><br/>
		<div class="clear"></div><br/>
		<div class="clear"></div><br/>
		<a class="button red large" href="https://github.com/lballaty/smarthouse"><i class="fa fa-cloud-download"></i> Download Apps (Github)</a> 
		<span style="white-space: nowrap;">
		<a class="button blue large" href=""><i class="fa fa-facebook"></i></a>
		<a class="button blue large" href=""><i class="fa fa-bell"></i></a>
		<a class="button blue large" href="mailto:liborballaty@gmail.com"><i class="fa fa-envelope"></i></a></span><br />
		<p>Downloaded a few times</p> 
		<div class="clear"></div><br/>
		<div class="clear"></div><br/>
		<div class="clear"></div><br/>
		<div class="clear"></div><br/>
	</div>

	</div>
 

</body>
<script>
    var socket = io('/iot');
	
	// set connection actions
	socket.on('connect', onConnect);
	socket.on('connect_error', onConnectError);
	socket.on('error', onError);
    socket.on('device', receiveDevice);
	socket.on('device_response', onResponse);
	
	function receiveDevice(msg) {
		updateDevice(msg);
		var FID = msg.raspyID + '-' + msg.devID + '-' + msg.ardID;
		console.log('got value');
		if (msg.activated == true) {
		
			if (document.getElementById(FID + '_row') == null) {
				/* this is a new device so whole div structure needs to be created */
				addActiveDeviceTableRow(msg);
				$("#" + FID + "_activate").click(function() {
					//console.log('test');
					var device = {};
					device.ardID = msg.ardID;
					device.devID = msg.devID;
					device.raspyID = msg.raspyID;
					device.activated = false;
					var buttonFID = FID;

					socket.emit('device_update', device);
					$('#' + buttonFID + '_row').remove();
				});
				$("#" + FID + "_switch").click(function() {
					var device = {};
					var FMessage = {};
					device.ardID = msg.ardID;
					device.devID = msg.devID;
					device.raspyID = msg.raspyID;
					device.activated = false;
					var command = '1'; // 0x1 == 'lightON';
					if (getDeviceValue(device) == '1')
						command = '2'; // 0x2 == 'lightOFF'
					console.log('DeviceValue: ' + getDeviceValue(device));
					FMessage.command = command;
					FMessage.device = device;
					var buttonFID = FID;
					setDeviceCommandOn(device);
					grayOutLightButton(device);
					setTimeout(function() { onCommandTimeout(device); }, 5000);
					socket.emit('device_command', FMessage);
					//$('#' + buttonFID + '_row').remove();
				});
			} else {
				/* the device already reported, structre needs to be filled in with new data */
				$("#" + FID + "_value").text(devValueGetName(msg.devType, msg.value));
				makeGreenLightButton(msg);
			}
		}
    }
	
	function addActiveDeviceTableRow(device) {
		var FID = device.raspyID + '-' + device.devID + '-' + device.ardID;
		
		var row = '<tr id="' + FID + '_row" class="w3-hover-grey">';
		row += '<td>' + device.desc + '</td>';		
		row += '<td>' + devTypeGetName(device.devType) + '</td>';
		row += '<td id="' + FID + '_value">' + devValueGetName(device.devType, device.value) + '</td>';
		row += '<td>' + createLightButton(device) + createActivationButton(device) + '</td></tr>';
		$("#devices").append(row);
	}
	
	function updateActiveDeviceTableRow(device) {
	
	}
	
	function onResponse(msg) {
		var response = msg.response;
		var device = msg.device;
		if (response != '0') {
			onError('Error reaching device: ' + device.desc + ' (' + response + ')');
		} else {
			updateActiveDeviceTableRow(device);
		}
		//console.log(JSON.stringify(msg));
	}
	//function update
</script>
</html>
